<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Redes Sociales</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


	</head>
		{% extends "core/base.html" %}
		{% load static %}
			{% block content %}
				{% if request.user.is_authenticated %}
				<header class="header">
					<div class="container">
						<div class="btn-menu">
							<label for="btn-menu">☰</label>
						</div>
						<div class="logo">
							<h4>Bienvenido {{ user.username | upper }}</h4>
						</div>
						<div class="image-menu">
							<img src = "{% static "Images/LogoBlancoTC.png" %}" alt="Telecable">
						</div>
						<nav class="menu">
							<a href="#">Inicio</a>
							<a href="#">Nosotros</a>
							<a href="#">Blog</a>
							<a>
								<form action="{% url 'logout' %}" method="post">
									{% csrf_token %}
									<button type="submit">Cerrar sesión</button>
								</form>
							</a>
						</nav>
					</div>
				</header>
				<!-- Menú desplegable -->
				<div class="capa"></div>
				<input type="checkbox" id="btn-menu">
				<div class="container-menu">
					<div class="cont-menu">
						<nav>
							<a href="{% url 'home' %}">Principal</a>
							<a href="{% url 'personalcc' %}">Personal CallCenter</a>
							<a href="{% url 'generate_report' %}">Reporte CallCenter</a>
							<a href="{% url 'whaticket' %}">MSJ Whaticket</a>
							<a href="{% url 'redessociales' %}">Redes Sociales</a>
							<a href="{% url 'ventascc' %}">Ventas CallCenter</a>
							<a href="{% url 'ventasvirtuales' %}">Ventas Virtuales</a>
							<a href="{% url 'personal_cajero' %}">Personal Cajero</a>
							<a href="{% url 'reportecaja' %}">Reporte Caja</a>
						</nav>
						<label for="btn-menu">✖️</label>
					</div>
				</div>
					<br>
					<body>
						<p class="p3">Redes Sociales</p>
						<div class="container-redessociales">
							<table id="tabla_tlaxcoapan" class="table table-striped table-custom">
								<thead>
									<tr>
										<th>SUCURSAL</th>
										<th>Total de mensajes</th>
										<th>Reporte de falla de servicio Internet</th>
										<th>Reporte de falla de servicio TV</th>
										<th>Falla General</th>
										<th>Info. para contrato nuevo</th>
										<th>Cambio de paquete</th>
										<th>Horarios de oficina</th>
										<th>Ubicación de sucursal</th>
										<th>Informe método de pago</th>
										<th>Promociones</th>
										<th>Sucursales de otras zonas</th>
										<th>Otros</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>Tlaxcoapan</td>
										<td><input type="number" class="form-control" name="Total_mensajes[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_internet[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_TV[]" /></td>
										<td><input type="number" class="form-control" name="Falla_general[]" /></td>
										<td><input type="number" class="form-control" name="Contrato_nuevo[]" /></td>
										<td><input type="number" class="form-control" name="Cambio_paquete[]" /></td>
										<td><input type="number" class="form-control" name="Horarios_oficina[]" /></td>
										<td><input type="number" class="form-control" name="Ubicación_sucursal[]" /></td>
										<td><input type="number" class="form-control" name="Metodo_pago[]" /></td>
										<td><input type="number" class="form-control" name="Promociones[]" /></td>
										<td><input type="number" class="form-control" name="Sucursales[]" /></td>
										<td><input type="number" class="form-control" name="Otros[]" /></td>
									</tr>
									<tr>
										<td>Tula</td>
										<td><input type="number" class="form-control" name="Total_mensajes[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_internet[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_TV[]" /></td>
										<td><input type="number" class="form-control" name="Falla_general[]" /></td>
										<td><input type="number" class="form-control" name="Contrato_nuevo[]" /></td>
										<td><input type="number" class="form-control" name="Cambio_paquete[]" /></td>
										<td><input type="number" class="form-control" name="Horarios_oficina[]" /></td>
										<td><input type="number" class="form-control" name="Ubicación_sucursal[]" /></td>
										<td><input type="number" class="form-control" name="Metodo_pago[]" /></td>
										<td><input type="number" class="form-control" name="Promociones[]" /></td>
										<td><input type="number" class="form-control" name="Sucursales[]" /></td>
										<td><input type="number" class="form-control" name="Otros[]" /></td>
									</tr>
									<tr>
										<td>Xaltianguis</td>
										<td><input type="number" class="form-control" name="Total_mensajes[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_internet[]" /></td>
										<td><input type="number" class="form-control" name="Fallas_TV[]" /></td>
										<td><input type="number" class="form-control" name="Falla_general[]" /></td>
										<td><input type="number" class="form-control" name="Contrato_nuevo[]" /></td>
										<td><input type="number" class="form-control" name="Cambio_paquete[]" /></td>
										<td><input type="number" class="form-control" name="Horarios_oficina[]" /></td>
										<td><input type="number" class="form-control" name="Ubicación_sucursal[]" /></td>
										<td><input type="number" class="form-control" name="Metodo_pago[]" /></td>
										<td><input type="number" class="form-control" name="Promociones[]" /></td>
										<td><input type="number" class="form-control" name="Sucursales[]" /></td>
										<td><input type="number" class="form-control" name="Otros[]" /></td>
									</tr>
								</tbody>
							</table>
							<button id="agregarBtn" class="btn btn-success">Agregar</button>
                			<button id="limpiarDatosBtn" class="btn btn-danger">Limpiar Datos</button>
						</div>

						<div id="resultados_RS" class="container-redessociales" >
							<table id="tabla_resumen" class="table table-striped table-custom" >
								<thead>
									<tr>
										<th>SUCURSAL</th>
										<th>Total de mensajes</th>
										<th>Reporte de falla de servicio Internet</th>
										<th>Reporte de falla de servicio TV</th>
										<th>Falla General</th>
										<th>Info. para contrato nuevo</th>
										<th>Cambio de paquete</th>
										<th>Horarios de oficina</th>
										<th>Ubicación de sucursal</th>
										<th>Informe método de pago</th>
										<th>Promociones</th>
										<th>Sucursales de otras zonas</th>
										<th>Otros</th>
									</tr>
								</thead>
								<tbody>
									<!-- Aquí se añadirán las filas dinámicamente -->
								</tbody>
							</table>
							<canvas id="graficaMensajes" width="600" height="600" style="display: block; margin-left: auto; margin-right: auto;"></canvas>
							<p class="p3">Gráficas por Zona</p>
							<canvas id="graficaTlaxcoapan" width="600" height="600" style="display: block; margin-left: auto; margin-right: auto;"></canvas>
							<canvas id="graficaTula" width="600" height="600" style="display: block; margin-left: auto; margin-right: auto;"></canvas>
							<canvas id="graficaXaltianguis" width="600" height="600" style="display: block; margin-left: auto; margin-right: auto;"></canvas>
							<button id="añadirReporteRedesBtn" onclick="añadirRedesSocialesAlReporte()" class="btngenerar">Añadir al reporte general</button>
						</div>
						
						<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
						<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
						<script>
							document.addEventListener('DOMContentLoaded', function() {
								function actualizarGrafica() {
									var tlaxcoapanTotal = 0;
									var tulaTotal = 0;
									var xaltianguisTotal = 0;
							
									// Obtener los datos de la tabla resumen
									var table = document.getElementById('tabla_resumen');
									var rows = table.getElementsByTagName('tr');
							
									for (var i = 1; i < rows.length; i++) { // Empezar desde 1 para omitir el encabezado
										var cells = rows[i].getElementsByTagName('td');
										var sucursal = cells[0].innerText;
										var totalMensajes = parseInt(cells[1].innerText) || 0;
							
										if (sucursal === 'Tlaxcoapan') {
											tlaxcoapanTotal += totalMensajes;
										} else if (sucursal === 'Tula') {
											tulaTotal += totalMensajes;
										} else if (sucursal === 'Xaltianguis') {
											xaltianguisTotal += totalMensajes;
										}
									}
							
									// Datos para la gráfica de pastel
									var totalMensajes = {
										Tlaxcoapan: tlaxcoapanTotal,
										Tula: tulaTotal,
										Xaltianguis: xaltianguisTotal
									};
							
									var ctxPie = document.getElementById('graficaMensajes').getContext('2d');
									if (Chart.getChart(ctxPie)) {
										Chart.getChart(ctxPie).destroy();
									}
									new Chart(ctxPie, {
										type: 'pie',
										data: {
											labels: ['Tlaxcoapan', 'Tula', 'Xaltianguis'],
											datasets: [{
												label: 'Total de mensajes por zona',
												data: [totalMensajes.Tlaxcoapan, totalMensajes.Tula, totalMensajes.Xaltianguis],
												backgroundColor: [
													'rgba(255, 99, 132, 0.2)',
													'rgba(54, 162, 235, 0.2)',
													'rgba(75, 192, 192, 0.2)'
												],
												borderColor: [
													'rgba(255, 99, 132, 1)',
													'rgba(54, 162, 235, 1)',
													'rgba(75, 192, 192, 1)'
												],
												borderWidth: 1
											}]
										},
										options: {
											responsive: false, // Deshabilitar respuesta
											maintainAspectRatio: false, // Mantener proporción
											plugins: {
												title: {
													display: true,
													text: 'Distribución de Mensajes por Zona', // Título del gráfico
													font: {
														size: 25 // Tamaño de la fuente del título
													},
													padding: {
														top: 10,
														bottom: 30
													}
												},
												legend: {
													position: 'left',
												},
												tooltip: {
													callbacks: {
														label: function(tooltipItem) {
															return tooltipItem.label + ': ' + tooltipItem.raw;
														}
													}
												}
											}
										}
									});
							
									// Crear y actualizar las nuevas gráficas de barras
									var zonas = ['Tlaxcoapan', 'Tula', 'Xaltianguis'];
									var graficas = {
										Tlaxcoapan: document.getElementById('graficaTlaxcoapan').getContext('2d'),
										Tula: document.getElementById('graficaTula').getContext('2d'),
										Xaltianguis: document.getElementById('graficaXaltianguis').getContext('2d')
									};
							
									zonas.forEach(function(zona) {
										if (Chart.getChart(graficas[zona])) {
											Chart.getChart(graficas[zona]).destroy();
										}
										var data = [];
										var labels = [];
							
										for (var i = 1; i < rows.length; i++) {
											var cells = rows[i].getElementsByTagName('td');
											var sucursal = cells[0].innerText;
							
											if (sucursal === zona) {
												for (var j = 1; j < cells.length; j++) {
													data.push(parseInt(cells[j].innerText) || 0);
													labels.push(table.rows[0].cells[j].innerText);
												}
											}
										}
							
										new Chart(graficas[zona], {
											type: 'bar',
											data: {
												labels: labels,
												datasets: [{
													label: zona,
													data: data,
													backgroundColor: 'rgba(75, 192, 192, 0.2)',
													borderColor: 'rgba(75, 192, 192, 1)',
													borderWidth: 1
												}]
											},
											options: {
												responsive: false,
												maintainAspectRatio: false,
												plugins: {
													title: {
														display: true,
														text: zona, // Aquí defines el título del gráfico
														font: {
															size: 20 // Tamaño de la fuente del título
														},
														padding: {
															top: 10,
															bottom: 30
														}
													}
												},
												scales: {
													y: {
														beginAtZero: true,
														ticks: {
															// Ajustar el tamaño de la fuente de las etiquetas del eje y
															font: {
																size: 14
															}
														}
													},
													x: {
														ticks: {
															// Ajustar el tamaño de la fuente de las etiquetas del eje x
															font: {
																size: 14
															}
														}
													}
												}
											}
										});
									});
								}
							
								document.getElementById('agregarBtn').addEventListener('click', function() {
									var tablas = ['tabla_tlaxcoapan', 'tabla_tula', 'tabla_xaltianguis'];
									var resumenTable = document.getElementById('tabla_resumen').getElementsByTagName('tbody')[0];
									resumenTable.innerHTML = '';
									// Almacenar los totales de mensajes por zona
									var totalMensajes = {
										Tlaxcoapan: 0,
										Tula: 0,
										Xaltianguis: 0
									};
							
									tablas.forEach(function(tablaId) {
										var table = document.getElementById(tablaId);
										var filas = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
							
										for (var i = 0; i < filas.length; i++) {
											var dataRow = filas[i];
											var newRow = resumenTable.insertRow();
							
											for (var j = 0; j < dataRow.cells.length; j++) {
												var cell = dataRow.cells[j];
												var newCell = newRow.insertCell(j);
							
												if (j === 0) { // Primera columna (Sucursal)
													newCell.innerText = cell.innerText;
												} else { // Otras columnas (inputs)
													var input = cell.querySelector('input');
													newCell.innerText = input.value;
							
													// Sumar el total de mensajes
													if (j === 1) { // Columna de "Total de mensajes"
														totalMensajes[dataRow.cells[0].innerText] += parseInt(input.value) || 0;
													}
												}
											}
										}
										actualizarGrafica();
									});
									// Actualizar la gráfica de pastel y las gráficas de barras
									actualizarGrafica();
								});
							
								document.getElementById('limpiarDatosBtn').addEventListener('click', function() {

																
									// Limpiar los datos de las tablas de resumen
									var resumenTable = document.getElementById('tabla_resumen').getElementsByTagName('tbody')[0];
									resumenTable.innerHTML = '';
							
									// Limpiar las gráficas
									var ctxPie = document.getElementById('graficaMensajes').getContext('2d');
									var pieChart = Chart.getChart(ctxPie);
									if (pieChart) {
										pieChart.destroy();
									}
							
									var zonas = ['Tlaxcoapan', 'Tula', 'Xaltianguis'];
									zonas.forEach(function(zona) {
										var ctxBar = document.getElementById('grafica' + zona).getContext('2d');
										var barChart = Chart.getChart(ctxBar);
										if (barChart) {
											barChart.destroy();
										}
									});

									// IDs de las tablas que se van a limpiar
									var tablas = ['tabla_tlaxcoapan', 'tabla_tula', 'tabla_xaltianguis'];
							
									// Limpiar las entradas de las tablas
									tablas.forEach(function(tablaId) {
										var table = document.getElementById(tablaId);
										var inputs = table.querySelectorAll('input');
							
										inputs.forEach(function(input) {
											input.value = '';
										});
									});

								});
								
							});

							function obtenerDatosDeRedesSociales() {
								const secciones = [];
								const graficos = {};
							
								// Procesar la tabla principal
								const tablaResumen = document.querySelector("#tabla_resumen");
								if (tablaResumen) {
									const datos = [];
									tablaResumen.querySelectorAll("tbody tr").forEach((fila, index) => {
										console.log(`Procesando fila ${index}:`, fila.innerHTML); // Verificar las filas que se están leyendo
										const filaDatos = [];
										fila.querySelectorAll("td").forEach((celda) => {
											filaDatos.push(celda.textContent.trim());
										});
										datos.push(filaDatos);
									});
							
									console.log("Datos procesados:", datos); // Asegúrate de que todas las filas están aquí
									secciones.push({
										titulo: "RESUMEN DE MENSAJES POR SUCURSAL",
										datos,
									});
								}
							
								// Procesar gráficos
								const graficosIds = [
									"graficaMensajes",
									"graficaTlaxcoapan",
									"graficaTula",
									"graficaXaltianguis",
								];
							
								graficosIds.forEach((id) => {
									const canvas = document.getElementById(id);
									if (canvas) {
										const titulo = canvas.previousElementSibling?.innerText || `Gráfico ${id}`;
										graficos[titulo] = canvas.toDataURL("image/png");
										console.log(`Gráfico procesado: ${titulo}`);
									} else {
										console.warn(`No se encontró el gráfico con ID: ${id}`);
									}
								});
							
								return { secciones, graficos };
							}							
														
							function añadirRedesSocialesAlReporte() {
								const redesData = obtenerDatosDeRedesSociales();
								const existingData = JSON.parse(localStorage.getItem("reporteRedesSociales")) || {};
							
								const updatedData = {
									...existingData,
									secciones: redesData.secciones,
									graficos: redesData.graficos,
								};
							
								console.log("Datos que se guardan en localStorage:", updatedData); // Verifica que contenga las 3 sucursales
								localStorage.setItem("reporteRedesSociales", JSON.stringify(updatedData));
								alert("Resumen de Redes Sociales añadido al reporte.");
							}													
						</script>							
					</body>
				{% endif %}
			{% endblock %}
</html>